<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MatchMyVibe Demo</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; max-width: 600px; }
    form { margin-bottom: 20px; }
    input, button { padding: 8px; margin: 5px 0; width: 100%; box-sizing: border-box; }
    .hidden { display: none; }
    .persona { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    .swipe-buttons button { margin-right: 10px; }
    .error { color: red; }
    .success { color: green; }
  </style>
</head>
<body>
  <h1>MatchMyVibe</h1>

  <div id="auth-section">
    <div id="signup-form" class="hidden">
      <h2>Signup</h2>
      <form id="form-signup">
        <input type="text" name="name" placeholder="Name" required />
        <input type="email" name="email" placeholder="Email (must end with .com)" required />
        <input type="password" name="password" placeholder="Password" required />
        <input type="date" name="dob" placeholder="Date of Birth" required />
        <button type="submit">Sign Up</button>
      </form>
      <p><a href="#" id="show-login">Already have an account? Login</a></p>
      <p id="signup-message"></p>
    </div>

    <div id="login-form">
      <h2>Login</h2>
      <form id="form-login">
        <input type="email" name="email" placeholder="Email" required />
        <input type="password" name="password" placeholder="Password" required />
        <button type="submit">Login</button>
      </form>
      <p><a href="#" id="show-signup">Don't have an account? Sign Up</a></p>
      <p id="login-message"></p>
    </div>
  </div>

  <div id="user-section" class="hidden">
    <h2>Welcome, <span id="user-name"></span>!</h2>
    <p>DOB: <span id="user-dob"></span></p>

    <h3>Your Traits</h3>
    <pre id="user-traits">Loading...</pre>

    <h3>Personas to Swipe</h3>
    <div id="personas-container">Loading personas...</div>

    <button id="logout-button">Logout</button>
  </div>

<script>
  const authSection = document.getElementById("auth-section");
  const loginFormDiv = document.getElementById("login-form");
  const signupFormDiv = document.getElementById("signup-form");
  const showSignupLink = document.getElementById("show-signup");
  const showLoginLink = document.getElementById("show-login");
  const loginMessage = document.getElementById("login-message");
  const signupMessage = document.getElementById("signup-message");
  const userSection = document.getElementById("user-section");
  const userNameSpan = document.getElementById("user-name");
  const userDobSpan = document.getElementById("user-dob");
  const userTraitsPre = document.getElementById("user-traits");
  const personasContainer = document.getElementById("personas-container");
  const logoutButton = document.getElementById("logout-button");

  // Show signup form
  showSignupLink.addEventListener("click", e => {
    e.preventDefault();
    loginFormDiv.classList.add("hidden");
    signupFormDiv.classList.remove("hidden");
    loginMessage.textContent = "";
    signupMessage.textContent = "";
  });

  // Show login form
  showLoginLink.addEventListener("click", e => {
    e.preventDefault();
    signupFormDiv.classList.add("hidden");
    loginFormDiv.classList.remove("hidden");
    signupMessage.textContent = "";
    loginMessage.textContent = "";
  });

  // Signup form submit
  document.getElementById("form-signup").addEventListener("submit", async e => {
    e.preventDefault();
    signupMessage.textContent = "";
    const formData = new FormData(e.target);
    try {
      const response = await fetch("/signup", {
        method: "POST",
        body: formData,
      });
      const text = await response.text();
      if (text.includes("Signup successful")) {
        signupMessage.textContent = "Signup successful! Redirecting...";
        signupMessage.className = "success";
        setTimeout(() => location.reload(), 1000);
      } else {
        signupMessage.textContent = "Signup failed. Check details.";
        signupMessage.className = "error";
      }
    } catch (err) {
      signupMessage.textContent = "Error signing up.";
      signupMessage.className = "error";
    }
  });

  // Login form submit
  document.getElementById("form-login").addEventListener("submit", async e => {
    e.preventDefault();
    loginMessage.textContent = "";
    const formData = new FormData(e.target);
    try {
      const response = await fetch("/login", {
        method: "POST",
        body: formData,
      });
      if (response.redirected) {
        location.reload();
      } else {
        const text = await response.text();
        loginMessage.textContent = "Invalid credentials.";
        loginMessage.className = "error";
      }
    } catch (err) {
      loginMessage.textContent = "Error logging in.";
      loginMessage.className = "error";
    }
  });

  // Logout
  logoutButton.addEventListener("click", async () => {
    await fetch("/logout");
    location.reload();
  });

  async function fetchUserInfo() {
    try {
      // Fetch traits
      const traitsRes = await fetch("/receive_traits");
      const traitsData = await traitsRes.json();

      if (traitsData.traits) {
        userTraitsPre.textContent = JSON.stringify(traitsData.traits, null, 2);
      } else {
        userTraitsPre.textContent = "No traits found.";
      }

      // Fetch personas
      const personasRes = await fetch("/get_personas");
      const personas = await personasRes.json();

      personasContainer.innerHTML = "";
      personas.forEach(persona => {
        const div = document.createElement("div");
        div.className = "persona";
        div.innerHTML = `
          <strong>${persona.name || "Unnamed"}</strong><br/>
          DOB: ${persona.dob || "N/A"}<br/>
          Vibe: ${persona.vibe || ""}<br/>
          Traits: ${JSON.stringify(persona.traits)}<br/>
          <div class="swipe-buttons">
            <button data-id="${persona.id}" data-direction="right">Like</button>
            <button data-id="${persona.id}" data-direction="left">Dislike</button>
          </div>
        `;
        personasContainer.appendChild(div);
      });

      // Attach swipe handlers
      document.querySelectorAll(".swipe-buttons button").forEach(button => {
        button.addEventListener("click", async (e) => {
          const target = e.target.getAttribute("data-id");
          const direction = e.target.getAttribute("data-direction");
          const formData = new FormData();
          formData.append("target", target);
          formData.append("direction", direction);
          const res = await fetch("/swipe", { method: "POST", body: formData });
          const data = await res.json();
          alert(data.status || "Swipe recorded");
        });
      });
    } catch (err) {
      personasContainer.textContent = "Error loading personas.";
      userTraitsPre.textContent = "";
    }
  }

  async function checkLogin() {
    try {
      const res = await fetch("/");
      if (res.redirected) {
        // Not logged in, show auth
        authSection.classList.remove("hidden");
        userSection.classList.add("hidden");
      } else {
        // Logged in, get user data from page html (injected by FastAPI)
        const html = await res.text();
        const nameMatch = html.match(/"name":\s*"([^"]+)"/);
        const dobMatch = html.match(/"dob":\s*"([^"]+)"/);

        if (nameMatch && dobMatch) {
          userNameSpan.textContent = nameMatch[1];
          userDobSpan.textContent = dobMatch[1];
          authSection.classList.add("hidden");
          userSection.classList.remove("hidden");
          fetchUserInfo();
        } else {
          authSection.classList.remove("hidden");
          userSection.classList.add("hidden");
        }
      }
    } catch {
      authSection.classList.remove("hidden");
      userSection.classList.add("hidden");
    }
  }

  // Run on page load
  checkLogin();

</script>
</body>
</html>